# ออกแบบระบบ MANTA

เอกสารนี้อธิบายการออกแบบระบบ MANTA (Monitoring and Analytics Node for Tracking Activity) ซึ่งเป็นระบบตรวจจับและวิเคราะห์การเคลื่อนไหวของบุคคลบน Raspberry Pi

## ภาพรวมระบบ

MANTA มีองค์ประกอบหลักดังนี้:

1. **ระบบตรวจจับบุคคล**: ใช้โมเดล YOLOv8 เพื่อตรวจจับบุคคลในวิดีโอสตรีม
2. **ระบบจดจำบุคคล**: ใช้อัลกอริธึมสกัดคุณลักษณะเพื่อติดตามบุคคลระหว่างเฟรม
3. **ระบบบันทึกกิจกรรม**: บันทึกข้อมูลกิจกรรมและสถิติต่างๆ
4. **ระบบอัปโหลด**: ซิงโครไนซ์ข้อมูลกับ Firebase Cloud
5. **การกำหนดค่าระยะไกล**: อินเทอร์เฟซการกำหนดค่าผ่าน HTTP และ WiFi Direct
6. **รองรับกล้องหลายประเภท**: รวมถึงกล้อง Raspberry Pi Camera, กล้อง USB และกล้อง Insta360 ผ่าน WebCam Protocol

## แผนภาพสถาปัตยกรรม

ระบบ MANTA มีแผนภาพสถาปัตยกรรมหลายประเภทที่สร้างด้วย D2:

- **แผนภาพสถาปัตยกรรมระบบ**: แสดงส่วนประกอบหลักของระบบ MANTA ทั้งหมด
- **แผนภาพการไหลของข้อมูล**: แสดงวิธีการไหลของข้อมูลผ่านระบบ
- **แผนภาพการกำหนดค่าเครือข่าย**: แสดงการเชื่อมต่อเครือข่ายต่างๆ
- **แผนภาพการกำหนดค่ากล้อง**: แสดงการกำหนดค่ากล้องและระบบการกำหนดค่าระยะไกล
- **แผนภาพคอมโพเนนต์**: แสดงความสัมพันธ์ระหว่างคอมโพเนนต์ในโค้ด

แผนภาพเหล่านี้สามารถดูได้ในรูปแบบ SVG หลังจากสร้างด้วยเครื่องมือ D2:

```bash
./scripts/generate_diagrams.sh
```

หลังจากสร้างไฟล์ SVG คุณสามารถดูแผนภาพได้ในไดเร็กทอรี `docs/d2/`

## ส่วนประกอบหลัก

### 1. โมดูลหลัก (main.py)

โมดูลหลักทำหน้าที่ประสานงานทุกส่วนของระบบ:
- เริ่มต้นกล้องและส่วนประกอบหลักทั้งหมด
- ประมวลผลเฟรมวิดีโอ
- ส่งต่อข้อมูลไปยังตัวตรวจจับและระบบจดจำบุคคล
- จัดการผู้ใช้งาน (ในโหมดดีบัก)

### 2. ระบบตรวจจับบุคคล (detection.py)

ใช้โมเดล YOLO สำหรับตรวจจับบุคคล:
- โหลดโมเดล YOLO ในรูปแบบ ONNX
- ตรวจจับบุคคลในแต่ละเฟรม
- กรองผลลัพธ์ตามความเชื่อมั่น
- รองรับการเร่งความเร็วด้วยฮาร์ดแวร์ในอนาคต

### 3. ระบบจดจำบุคคล (reid.py)

ติดตามบุคคลระหว่างเฟรม:
- สกัดเวกเตอร์คุณลักษณะจากบุคคลที่ตรวจจับได้
- คำนวณความเหมือนระหว่างคุณลักษณะ
- กำหนด ID เฉพาะให้กับแต่ละบุคคล
- ติดตามการเข้าและออกของบุคคล

### 4. ระบบบันทึกกิจกรรม (logger.py)

บันทึกข้อมูลกิจกรรมและสถิติ:
- บันทึกเวลาเข้าและออกของบุคคล
- บันทึกจำนวนบุคคลที่ตรวจจับได้ในแต่ละช่วงเวลา
- สร้างสรุปสถิติการใช้งานพื้นที่
- จัดการการหมุนเวียนไฟล์บันทึก

### 5. ระบบอัปโหลด (uploader.py)

ซิงโครไนซ์ข้อมูลกับ Firebase:
- อัปโหลดข้อมูลกิจกรรมไปยัง Firebase
- รองรับการแคชข้อมูลเมื่อไม่มีการเชื่อมต่อ
- ลองใหม่อัตโนมัติเมื่อเครือข่ายกลับมาใช้งานได้
- รองรับการเข้ารหัสข้อมูลที่สำคัญ

### 6. ระบบการกำหนดค่าระยะไกล (remote_config.py)

จัดการการกำหนดค่าระยะไกล:
- ให้บริการเว็บอินเทอร์เฟซสำหรับการกำหนดค่า
- รองรับการเชื่อมต่อผ่าน WiFi Direct
- อัปเดตการตั้งค่าแบบเรียลไทม์
- รองรับการรีสตาร์ทระบบจากระยะไกล

### 7. รองรับกล้องภายนอก (webcam_utils.py)

เชื่อมต่อกับกล้องภายนอกเช่น Insta360:
- รองรับการเชื่อมต่อผ่าน WebCam Protocol
- จัดการการเชื่อมต่อ WiFi กับกล้อง
- รับสตรีม RTMP จากกล้อง
- แปลงสตรีมให้เข้ากับระบบ MANTA

## การไหลของข้อมูล

1. **การรับภาพ**: กล้องส่งเฟรมวิดีโอไปยังโมดูลหลัก
2. **การตรวจจับ**: โมดูลหลักส่งเฟรมไปยังตัวตรวจจับบุคคล
3. **การจดจำ**: ภาพบุคคลที่ตรวจจับได้ถูกส่งไปยังระบบจดจำบุคคล
4. **การบันทึก**: ข้อมูลบุคคลที่จดจำได้ถูกบันทึกในระบบบันทึกกิจกรรม
5. **การอัปโหลด**: ข้อมูลกิจกรรมถูกส่งไปยัง Firebase
6. **การแจ้งเตือน**: เหตุการณ์สำคัญสามารถทริกเกอร์การแจ้งเตือนผ่าน n8n

## การกำหนดค่าระบบ

MANTA ใช้ไฟล์การกำหนดค่าหลายประเภท:

- **config.yaml**: การกำหนดค่าหลัก
- **config.rpi4.yaml/config.rpi5.yaml**: การกำหนดค่าเฉพาะสำหรับ Raspberry Pi แต่ละรุ่น
- **config.webcam.yaml**: การกำหนดค่าสำหรับการเชื่อมต่อกับกล้อง WebCam
- **firebase_config.json**: ข้อมูลประจำตัวสำหรับ Firebase

การกำหนดค่าสามารถปรับแต่งได้ผ่าน:
- การแก้ไขไฟล์โดยตรง
- ระบบการกำหนดค่าระยะไกลผ่านเว็บอินเทอร์เฟซ
- การเชื่อมต่อ WiFi Direct สำหรับการกำหนดค่าในสถานที่

## ความปลอดภัย

MANTA มีการปกป้องความปลอดภัยหลายระดับ:

- **การเข้ารหัสข้อมูลสำคัญ**: ข้อมูลประจำตัว Firebase และข้อมูลอ่อนไหวอื่นๆ
- **การเข้าถึงการกำหนดค่าที่ปลอดภัย**: เพื่อป้องกันการเข้าถึงโดยไม่ได้รับอนุญาต
- **การจัดการโทเค็น**: สำหรับการรับรองความถูกต้องกับบริการภายนอก
- **การล็อกการกำหนดค่าดิสก์**: เพื่อป้องกันการแก้ไขโดยไม่ได้รับอนุญาต

## การเตรียมระบบสำหรับการเพิ่มเติมในอนาคต

ระบบ MANTA ได้รับการออกแบบให้มีความยืดหยุ่นสำหรับการขยายในอนาคต:

- **โครงสร้างแบบโมดูลาร์**: ส่วนประกอบสามารถแทนที่หรือขยายได้อย่างอิสระ
- **นามธรรมของฮาร์ดแวร์**: รองรับแพลตฟอร์มฮาร์ดแวร์ที่หลากหลาย
- **อินเทอร์เฟซที่เป็นมาตรฐาน**: ทำให้เข้ากันได้กับระบบอื่นๆ
- **การออกแบบที่ขยายได้**: พร้อมรองรับฟีเจอร์ใหม่

## การทดสอบ

MANTA มีกลยุทธ์การทดสอบหลายระดับ:

- **การทดสอบหน่วย**: ทดสอบส่วนประกอบแต่ละส่วนแยกกัน
- **การทดสอบบูรณาการ**: ทดสอบการทำงานร่วมกันของส่วนประกอบต่างๆ
- **การทดสอบประสิทธิภาพ**: ตรวจสอบความเร็วและการใช้ทรัพยากร
- **การทดสอบบน macOS**: สำหรับการพัฒนา
- **การทดสอบบน Raspberry Pi**: สำหรับการทำงานจริง

## ข้อมูลเพิ่มเติม

สำหรับข้อมูลเพิ่มเติมเกี่ยวกับการออกแบบระบบ โปรดดูที่:

- [แผนภาพ D2](docs/d2/README.md)
- [คู่มือสำหรับนักพัฒนา](developer_guide.md)
- [ข้อมูลจำเพาะทางเทคนิค](technical_specification.md)